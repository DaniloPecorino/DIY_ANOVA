---
title: "ANOVA report"
author: ""
date: "07 giugno 2018"
output:
  html_document: default
  word_document: default
params:
  transformation: none
  posthoc: none
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## 0. Report structure

This a report automatically generated by the DIY_ANOVA app (<https://pecostats.shinyapps.io/DIY_ANOVA/>). It consists of the following sections:

1. Input data
2. Normality
3. Homoscedasticity
4. ANOVA results
5. Post-hoc test

## 1. Input data

```{r include=FALSE}
inData <- readRDS("inData.rds")
response <- readRDS("response.rds")
predictors <- readRDS("predictors.rds")


inputs <- vector(mode = "list", length = 5)
names(inputs) <- c("nRecords", "nVariables", "variablesNames", "predictorName", "factorsNames")

inputs$nRecords <- nrow(inData)
inputs$nVariables <- ncol(inData)
inputs$variablesNames <- colnames(inData)
inputs$predictorsNames <- predictors
inputs$responseNames <- response

```
The input dataset has **`r inputs$nRecords` records** and **`r inputs$nVariables` variables**: *`r inputs$variablesNames`*.
For the following analysis, **`r inputs$predictorsNames`** will be modelled as categorical predictive variables (factors), and **`r inputs$responseNames`** as a continuous response variable.


## 2. Normality

```{r echo = FALSE, message = FALSE, warning = FALSE}
if(params$transformation == 'none'){
      transText <- NULL
    }else if(params$transformation == 'sqrt'){
      transText <- "transformed (square root)"
    }else if(params$transformation == 'log'){
      transText <- "transformed (natural logarithm of x + 1)"
    }else if(params$transformation == 'asinroot'){
      transText <- "transformed (arcsine of square root)"
    }

```

```{r echo = FALSE, message = FALSE, warning = FALSE}
test_results <- readRDS("test_results.rds")
trans_test_results <- readRDS("trans_test_results.rds")
if(params$transformation == 'none'){
      normResults <- test_results
    }else{
      normResults <- trans_test_results
    }

```

A **`r normResults$method`** was performed on the `r transText` response variable was **`r ifelse(normResults$p.value > 0.5, "not significant", "significant")`** (D statistic = `r formatC(normResults$statistic)`, p-value = `r formatC(normResults$p.value)`). The distribution of the response variable, therefore, is `r ifelse(normResults$p.value > 0.5, "not", "significantly")`  significantly different from a normal distribution with the same mean and variance.

The followings charts are: **on the left a *QQ plot* ** produced to compare the distribution quantiles of the response variable with the theoretical quantiles of a normal distribution; **on the right a *bar chart* **that provides a visual representation of the distribution of the response variable itself.


```{r echo = FALSE, message = FALSE, warning = FALSE}
library(highcharter)
library(htmltools)
source("get_hist_data.R")
inData <- readRDS("inData.rds")
response <- readRDS("response.rds")
transformedData <- readRDS("transformedData.rds")
resp_col <- which(colnames(inData) == response)

if(params$transformation == 'none'){
      dataPlot <- inData[,resp_col]
    }else{
      dataPlot <- transformedData
    }

normPlots <- vector(mode = "list", length = 2)

qqPlot <- qqnorm(dataPlot, plot = F)
    qqPlot <- as.data.frame(qqPlot)
    qqPlot <- qqPlot[order(qqPlot$x),]
    mod <- lm(y ~ x, qqPlot)
    qqPlot$line <- predict(mod, newdata = data.frame(x = sort(qqPlot$x)))

normPlots[[1]] <- highchart() %>%
                    hc_add_series(data = qqPlot, 
                                  type = "scatter", 
                                  hcaes(x = x, y = y), 
                                  color = "#6fcb9f",
                                  name = "qqplot", 
                                  zIndex=1
                    ) %>%
                    hc_tooltip(formatter = JS("function(){
                                              return ('x: '+ Highcharts.numberFormat(this.x, 2) +', '+'y: '+ Highcharts.numberFormat(this.y, 2))
                                              }")
                                  ) %>%
                    hc_add_series(data = qqPlot,
                                  type = "spline",
                                  hcaes(x = x, 
                                        y = line),
                                  color = "#ff7f50",
                                  dashStyle = "ShortDot",
                                  marker = list(enabled = F)) %>%
                    hc_xAxis(
                      title = list(text = "Theoretical quantiles")
                    ) %>%
                    hc_yAxis(
                      title = list(text = "Sample quantiles")
                    ) %>%
                    hc_title(text = "QQ plot") %>%
                    hc_legend(enabled = FALSE) 


h <- hist(dataPlot, plot = F)
hx <- get_hist_data(h)
hx$color <- "#6fcb9f80"
                          
normPlots[[2]] <- highchart() %>%
                     hc_add_series(data = list_parse(hx), type = "column"
                                          ,groupPadding = 0
                                          ,pointPadding =  0) %>%
                      hc_tooltip(
                              formatter =
                                JS("function() { return  this.point.name + '<br/>' + this.y; }")
                            ) %>%
                      hc_xAxis(
                              title = list(text = colnames(inData[resp_col]))
                            ) %>%
                      hc_yAxis(
                              title = list(text = "Frequency")
                            ) %>%
                      hc_title(text = paste0("Histogram of ", colnames(inData[resp_col]))) %>%
                      hc_legend(enabled = FALSE)

hw_grid(normPlots, rowheight = 300, ncol = 2)

```

## 3. Homoscedasticity

```{r echo = FALSE, message = FALSE, warning = FALSE}
homoResults <- readRDS("homo_test_results.rds")

```

Homogeneity of variances (i.e. homoscedasticity) was tested via **`r names(homoResults$statistic)` test on `r inputs$responseNames` by `r inputs$predictorsNames`**. This test was **`r ifelse(homoResults$p.value > 0.5, "not significant", "significant")`** (`r names(homoResults$statistic)` statistic = `r formatC(homoResults$statistic)`, p-value = `r formatC(homoResults$p.value)`). The variance of the response variable among groups, therefore, can`r ifelse(homoResults$p.value > 0.5, "", "not")` be assumed to be homogeneous.


```{r echo = FALSE, message = FALSE, warning = FALSE}
library(highcharter)

inData <- readRDS("inData.rds")
response <- readRDS("response.rds")
predictors <- readRDS("predictors.rds")
transformedData <- readRDS("transformedData.rds")

resp_col <- which(colnames(inData) == response)

Data <- inData[, predictors]
Data <- data.frame(Data)
for(i in 1:ncol(Data)){Data[,i] <- as.character(Data[,i])}
Data$var <- NA
for(i in 1:nrow(Data)){
  Data[i,]$var <- paste0(Data[i,1:(ncol(Data)-1)], collapse = "_")
}
x <- cbind(transformedData, Data)
x$color <- colorize(x$var)
height <- 200*sqrt(length(unique(x$var)))


highchart(height = height) %>%
  hc_chart(inverted = T) %>%
  hc_legend(enabled = F) %>%
  hc_add_series_boxplot(x = x[,1], 
                        by = x$var,  
                        colorByPoint = FALSE,
                        fillColor = "#c0d6e4",
                        outliers = F) %>%
  hc_xAxis(categories = unique(x$var)) %>%
  hc_yAxis(
    title = list(text = colnames(inData)[resp_col])
  ) %>%
  hc_title(
    text = paste0(
      "Boxplot of ", 
      colnames(inData)[resp_col], 
      " by ", 
      paste(
        predictors, collapse = ", "
      )
    )
  ) %>%
  hc_tooltip(pointFormat = "Maximum: {point.high}<br/>
             Upper quartile: {point.q3}<br/>
             Median: {point.median}<br/>
             Lower quartile: {point.q1}<br/>
             Minimum: {point.low}<br/>")


```

## 4. ANOVA results

### 4.1.  ANOVA model and table

```{r echo = FALSE, message = FALSE, warning = FALSE}
predictors <- readRDS("predictors.rds")
nWay <- length(predictors)
```

```{r echo = FALSE, message = FALSE, warning = FALSE}
response <- readRDS("response.rds")
linear_model <- readRDS("linear_model.rds")

model <- gsub(
            "types\\$",
            "",
            paste(
              response,
              as.character(formula(linear_model$terms))[1],
              as.character(formula(linear_model$terms))[3],
              collapse = " "
            )
          )
```

```{r echo = FALSE, message = FALSE, warning = FALSE}
predictors <- readRDS("predictors.rds")
factors_definitions <- readRDS("factors_definitions.rds")

df <- cbind(predictors, factors_definitions)

df <- data.frame(cbind(predictors, factors_definitions))

df$factors_definitions <- as.character(df$factors_definitions)
df$predictors <- as.character(df$predictors)


if(any(!df$factors_definitions == "None")){
    df[!df$factors_definitions == "None", ]$factors_definitions <- "random"
}
if(any(df$factors_definitions == "None")){
    df[df$factors_definitions == "None", ]$factors_definitions <- "fixed"
}


definitions <- character()

for(i in 1:nrow(df)){
  definitions <- c(definitions, paste0(df[i, ], collapse = " as "))
}

definitions <- paste(definitions, collapse = ", ")
```

Factors were defined as follows: **`r definitions`**, and the linear model underlying this ANOVA is 

<center> **`r model`** </center>
<br>
Results of the `r nWay`-way ANOVA are shown in the following table:

```{r echo = FALSE, message = FALSE, warning = FALSE}
library(DT)
brks <- c(0,0.001, 0.01, 0.05)
clrs <- c("white", "#cc000060", "#ffc3a060","#ffc3a060", "white")
anova_results <- readRDS("anova_results.rds")

     res_form <- anova_results
     
     for(i in 1:ncol(anova_results)){
       
       res_form[,i] <- formatC(anova_results[,i], 3)
       
       res_form[is.na(anova_results[,i]), i] <- ""
       
     }
     
     
     datatable(res_form,options = list(dom = 't', pageLength = 50)) %>%
       formatStyle('Pr(>F)', target = 'row', backgroundColor = styleInterval(brks, clrs))

```
<br>

### 4.2.  Visualisation of the F tests

The following plots provide a visual representation of of the F test of each source of variability of the tested ANOVA model.

```{r echo = FALSE, message = FALSE, warning = FALSE}
library(highcharter)
library(htmltools)
anova_results <- readRDS("anova_results.rds")
F_source <- readRDS("F_source.rds")
F_den <- readRDS("F_den.rds")
alpha <- readRDS("alpha.rds")


charts <- vector(mode = "list")
for(i in 1:length(F_source)){
  
  if(is.na(F_den[i])){
    next
  }else{
    
    
    Fs <- data.frame(F_source[[i]])
    Fs$group <- as.character(Fs$x < Fs$hq)
    
    charts[[length(charts)+1]] <-
      Fs %>%
      hchart("areaspline", hcaes(x = x, y = F, group = group), color = c("#ff7f50", "#999999"))  %>%
      hc_xAxis(plotLines = list(
        list(
          label = list(
            text = paste0("F test = ",format(anova_results[i,]$"F value", digits=3)),
            rotation = 0,
            textAlign = "left",
            y = 15
          ),
          color = "#6dc066",
          dashStyle = "ShortDot",
          width = 2,
          value = anova_results[i,]$"F value",
          zIndex = 10
        ),
        list(
          label = list(
            text = paste0(as.character(alpha), "th quantile = ", format(F_source[[i]]$hq, digits=3)),
            rotation = 0,
            textAlign = "left",
            y = 30
          ),
          color = "red",
          dashStyle = "ShortDot",
          width = 2,
          value = F_source[[i]]$hq,
          zIndex = 10
        )
      ),
      title = list(text = "F ratio"),
      max = max(Fs$x)
      ) %>%
      hc_yAxis(title = list(text = "Probability"))%>%
      hc_title(text = names(F_source)[i]) %>%
      hc_legend(FALSE) %>%
      hc_tooltip(formatter = JS("function(){
                                return ('F ratio: '+ Highcharts.numberFormat(this.x, 3) +', '+'Probability: '+ Highcharts.numberFormat(this.y, 3))
  }")
      )
}
  
  }

hw_grid(charts, rowheight = 300, ncol = 1)

```



## 5. Post-hoc tests

Post-hoc tests are shown in the following table. `r ifelse(params$posthoc != "none", paste0("The ", params$posthoc), "No")` correction was applied to the p-values of each comparison. 
<br>
<br>
```{r echo = FALSE, message = FALSE, warning = FALSE}
library(DT)
ph_results <- readRDS("ph_results.rds")
predictors <- readRDS("predictors.rds")
ph_r_form <- ph_results
     
     for(i in 1:ncol(ph_results)){
       
       ph_r_form[,i] <- formatC(ph_results[,i], 4)
       
       ph_r_form[is.na(ph_results[,i]), i] <- ""
       
     }
     
     colnames(ph_r_form)[(length(predictors)+1):ncol(ph_r_form)] <- c("Least squares mean", "SE", "Df", "Lower CL", "Upper CL", "Group")
     
     
     datatable(ph_r_form,options = list(pageLength = 100), rownames = F) %>% formatStyle("Least squares mean",
                                                                             background = styleColorBar(range(as.numeric(ph_r_form$"Least squares mean")), 'lightblue'),
                                                                             backgroundSize = '98% 88%',
                                                                             backgroundRepeat = 'no-repeat',
                                                                             backgroundPosition = 'center')



```

<hr>
<font size = 1>This report was generated through the DIY_ANOVA app developed by Danilo Pecorino (danilo.pecorino@gmail.com). Do get in touch in case you find bugs or anything that does not work as you would expect; or just to say hi!</font>

